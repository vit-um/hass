# Автоматизация - Управление выключателем по датчику движения
light_auto:

# to do
# добавить в алгоритмы датчики освещенности
# добавить в алгоритмы датчик открытия двери с пылесосом

# Переключатель автоматического вкл/откл. освещения в помещении
    input_boolean:
      auto_light_on_off:
        name: Auto light on
    
# Таймер отключения освещения в помещении (180 секунд)
    timer:
      light_turn_off:
        name: Light turn off timer
        duration: 90

# Автоматизации
    automation:

# Действие 1. При включении выключателя автоматики происходит перезапуск таймера отключения освещения, если датчик движения в состоянии off и освещение включено.
    - id: 'turn_on_auto_light'
      alias: Auto light on
      trigger:
      - platform: state
        entity_id: input_boolean.auto_light_on_off
        to: 'on'
      condition:
      - condition: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2  
        state: 'off'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 2. При отключении выключателя автоматики если был запущен таймер отключения, то он отменяется.        
    - id: 'turn_off_auto_light'
      alias: Auto light off
      trigger:
      - platform: state
        entity_id: input_boolean.auto_light_on_off
        to: 'off'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 3. При включении освещения с выключателя происходит перезапуск таймера отключения, если выключатель автоматики on и датчик движения off.

    - id: 'turn_on_light'
      alias: Light turn on
      trigger:
      - platform: state
        entity_id: switch.sonoff_1000e7ffae_1
        to: 'on'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
          state: 'off'
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 4. При отключении освещения с выключателя если был запущен таймер отключения, то он отменяется.
    - id: 'turn_off_light'
      alias: Light turn off
      trigger:
      - platform: state
        entity_id: switch.sonoff_1000e7ffae_1
        to: 'off'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 5. При обнаружении движения включается освещение, если выключатель автоматики on и освещение на данный момент выключено.
    - id: 'turn_on_light_by_motion'
      alias: Light turn on by motion sensor
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'on'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'off'
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_2
          state: 'off'
        - condition: time
          after: '07:00:00'
          before: '23:00:00'
        - condition: numeric_state
          entity_id: sensor.illumination_7c49ebb42515
          below: 500
      action:
      - service: switch.turn_on
        data:
          entity_id: switch.sonoff_1000e7ffae_1

# Действие 6. При обнаружении движения происходит отмена таймера отключения при его активном текущем состоянии.
    - id: 'cancel_timer_by_motion'
      alias: Timer cancel by motion sensor 
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'on'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
# Действие 7. При окончании обнаружения движения датчиком, включенном выключателе автоматики и включенном свете происходит запуск таймера на отключения освещения.
    - id: 'start_timer_by_motion'
      alias: Timer start by motion sensor
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'off'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
# Действие 8. При окончании отсчета таймера происходит отключение освещения, если выключатель автоматики on, датчик движения off и освещение включено.
    - id: 'turn_off_light_by_timer'
      alias: Timer finished
      trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.light_turn_off
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
          state: 'off'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: switch.turn_off
        entity_id: switch.sonoff_1000e7ffae_1
        data: {}

# Автоматизация - Управление выключателем по датчику движения
light_auto:

# to do
# добавить в алгоритмы датчики освещенности
# добавить в алгоритмы датчик открытия двери с пылесосом

# Переключатель автоматического вкл/откл. освещения в помещении
    input_boolean:
      auto_light_on_off:
        name: Auto light on
    
# Таймер отключения освещения в помещении (180 секунд)
    timer:
      light_turn_off:
        name: Light turn off timer
        duration: 90

# Автоматизации
    automation:

# Действие 1. При включении выключателя автоматики происходит перезапуск таймера отключения освещения, если датчик движения в состоянии off и освещение включено.
    - id: 'turn_on_auto_light'
      alias: Auto light on
      trigger:
      - platform: state
        entity_id: input_boolean.auto_light_on_off
        to: 'on'
      condition:
      - condition: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2  
        state: 'off'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 2. При отключении выключателя автоматики если был запущен таймер отключения, то он отменяется.        
    - id: 'turn_off_auto_light'
      alias: Auto light off
      trigger:
      - platform: state
        entity_id: input_boolean.auto_light_on_off
        to: 'off'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 3. При включении освещения с выключателя происходит перезапуск таймера отключения, если выключатель автоматики on и датчик движения off.

    - id: 'turn_on_light'
      alias: Light turn on
      trigger:
      - platform: state
        entity_id: switch.sonoff_1000e7ffae_1
        to: 'on'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
          state: 'off'
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 4. При отключении освещения с выключателя если был запущен таймер отключения, то он отменяется.
    - id: 'turn_off_light'
      alias: Light turn off
      trigger:
      - platform: state
        entity_id: switch.sonoff_1000e7ffae_1
        to: 'off'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
        
# Действие 5. При обнаружении движения включается освещение, если выключатель автоматики on и освещение на данный момент выключено.
    - id: 'turn_on_light_by_motion'
      alias: Light turn on by motion sensor
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'on'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'off'
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_2
          state: 'off'
        - condition: time
          after: '07:00:00'
          before: '23:00:00'
        - condition: numeric_state
          entity_id: sensor.illumination_7c49ebb42515
          below: 500
      action:
      - service: switch.turn_on
        data:
          entity_id: switch.sonoff_1000e7ffae_1

# Действие 6. При обнаружении движения происходит отмена таймера отключения при его активном текущем состоянии.
    - id: 'cancel_timer_by_motion'
      alias: Timer cancel by motion sensor 
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'on'
      condition:
      - condition: state
        entity_id: timer.light_turn_off
        state: active
      action:
      - service: timer.cancel
        entity_id: timer.light_turn_off
        data: {}
# Действие 7. При окончании обнаружения движения датчиком, включенном выключателе автоматики и включенном свете происходит запуск таймера на отключения освещения.
    - id: 'start_timer_by_motion'
      alias: Timer start by motion sensor
      trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
        to: 'off'
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: timer.start
        entity_id: timer.light_turn_off
        data: {}
# Действие 8. При окончании отсчета таймера происходит отключение освещения, если выключатель автоматики on, датчик движения off и освещение включено.
    - id: 'turn_off_light_by_timer'
      alias: Timer finished
      trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.light_turn_off
      condition:
      - condition: state
        entity_id: input_boolean.auto_light_on_off
        state: 'on'
      - condition: and
        conditions:
        - condition: state
          entity_id: binary_sensor.motion_sensor_158d0002e9b4c2
          state: 'off'
      - condition: and
        conditions:
        - condition: state
          entity_id: switch.sonoff_1000e7ffae_1
          state: 'on'
      action:
      - service: switch.turn_off
        entity_id: switch.sonoff_1000e7ffae_1
        data: {}
